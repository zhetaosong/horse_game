<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>ğŸ é©¬å¹´æ‘‡ä¸€æ‘‡å¤§èµ›</title>

<style>
body {
    margin: 0;
    background: linear-gradient(#2c1b0f, #120a04);
    font-family: "PingFang SC", Arial;
    color: #fff;
    overflow: hidden;
}

h1 {
    text-align: center;
    margin: 12px 0;
    color: gold;
}

#status {
    text-align: center;
    font-size: 14px;
    opacity: 0.9;
}

#track {
    height: calc(100vh - 160px);
    overflow-y: auto;
    padding: 10px;
}

.horse {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.08);
    border-radius: 6px;
    padding: 6px;
}

.horse.me {
    border: 2px solid gold;
}

.rank {
    width: 28px;
    text-align: center;
    font-weight: bold;
}

.bar-wrap {
    flex: 1;
    background: #333;
    height: 18px;
    border-radius: 9px;
    overflow: hidden;
}

.bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg,#ffb703,#ffd60a);
    transition: width 0.1s;
}

.name {
    width: 90px;
    text-align: right;
    font-size: 12px;
    margin-left: 6px;
}

.champion {
    animation: glow 1s infinite alternate;
}

@keyframes glow {
    from { box-shadow: 0 0 6px gold; }
    to   { box-shadow: 0 0 20px gold; }
}

#startBtn {
    width: 90%;
    margin: 10px auto;
    display: block;
    padding: 12px;
    font-size: 18px;
    background: gold;
    color: #000;
    border: none;
    border-radius: 10px;
}

/* åå­—è¾“å…¥å±‚ */
#nameLayer {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
}

#nameBox {
    background: #1e120a;
    padding: 20px;
    border-radius: 12px;
    width: 80%;
    text-align: center;
}

#nameBox input {
    width: 100%;
    padding: 10px;
    font-size: 18px;
    border-radius: 8px;
    border: none;
    margin-bottom: 12px;
}

#nameBox button {
    width: 100%;
    padding: 10px;
    font-size: 18px;
    background: gold;
    border: none;
    border-radius: 8px;
}
</style>
</head>

<body>

<h1>ğŸ é©¬å¹´æ‘‡ä¸€æ‘‡å¤§èµ›</h1>
<div id="status">ç­‰å¾…ç©å®¶åŠ å…¥â€¦</div>
<button id="startBtn">å¼€å§‹æ¯”èµ›</button>
<div id="track"></div>

<!-- è¾“å…¥åå­— -->
<div id="nameLayer" style="display:none">
    <div id="nameBox">
        <h2>è¯·è¾“å…¥ä½ çš„åå­—</h2>
        <input id="nameInput" placeholder="å¦‚ï¼šå¼ ä¸‰ / Tony" />
        <button id="nameBtn">åŠ å…¥æ¯”èµ›</button>
    </div>
</div>

<audio id="hoof" src="https://cdn.jsdelivr.net/gh/jaywcjlove/audio@main/horse.mp3"></audio>

<script>
const myId = localStorage.getItem("horse_id") ||
    (Date.now() + "_" + Math.random()).slice(0,16);
localStorage.setItem("horse_id", myId);

let myName = localStorage.getItem("horse_name");

const players = JSON.parse(localStorage.getItem("players") || "[]");

if (!myName) {
    document.getElementById("nameLayer").style.display = "flex";
    document.getElementById("nameBtn").onclick = () => {
        const v = document.getElementById("nameInput").value.trim();
        myName = v || ("é©¬" + (players.length + 1));
        localStorage.setItem("horse_name", myName);
        document.getElementById("nameLayer").style.display = "none";
        join();
    };
} else {
    join();
}

function join() {
    if (!players.find(p => p.id === myId)) {
        players.push({
            id: myId,
            name: myName,
            progress: 0
        });
        localStorage.setItem("players", JSON.stringify(players));
    }
    render();
}

let started = false;
const track = document.getElementById("track");
const status = document.getElementById("status");
const hoof = document.getElementById("hoof");

function render() {
    players.sort((a,b)=>b.progress-a.progress);
    track.innerHTML = "";
    players.forEach((p,i)=>{
        const div = document.createElement("div");
        div.className = "horse" + (p.id===myId?" me":"");
        if (i===0 && started) div.classList.add("champion");

        div.innerHTML = `
            <div class="rank">${i+1}</div>
            <div class="bar-wrap">
                <div class="bar" style="width:${Math.min(p.progress,100)}%"></div>
            </div>
            <div class="name">${p.name}</div>
        `;
        track.appendChild(div);
    });

    if (started) status.innerText = "æ‘‡ä¸€æ‘‡ / ç‚¹å‡»å±å¹•å†²åˆºï¼";
}

document.getElementById("startBtn").onclick = () => {
    started = true;
    hoof.play();
};

function boost(v=1) {
    if (!started) return;
    const me = players.find(p=>p.id===myId);
    if (!me) return;
    me.progress += v;
    localStorage.setItem("players", JSON.stringify(players));
    render();
}

document.body.addEventListener("click", ()=>boost(1));

window.addEventListener("devicemotion", e => {
    const a = e.accelerationIncludingGravity;
    if (!a) return;
    const force = Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
    if (force > 18) boost(force*0.2);
});

setInterval(()=>{
    const data = JSON.parse(localStorage.getItem("players") || "[]");
    data.forEach(p=>{
        const local = players.find(x=>x.id===p.id);
        if (local) local.progress = p.progress;
    });
    render();
},300);
</script>

</body>
</html>