<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ğŸ é©¬å¹´èµ›é©¬ Â· æ‘‡ä¸€æ‘‡</title>

<meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               maximum-scale=1.0,
               user-scalable=no">

<style>
* {
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
}

html, body {
    margin: 0;
    padding: 0;
    overscroll-behavior: none;
    font-family: "Microsoft YaHei", sans-serif;
    background: linear-gradient(#8b1e1e, #c94a4a);
    color: #fff;
    text-align: center;
}

h1 {
    margin: 20px 0;
}

input, button {
    font-size: 16px;
    padding: 10px;
    margin: 6px;
    border-radius: 6px;
    border: none;
}

button {
    background: gold;
    cursor: pointer;
}

.track {
    width: 90%;
    max-width: 600px;
    height: 40px;
    background: #4a2a2a;
    margin: 20px auto;
    border-radius: 20px;
    position: relative;
}

.horse {
    position: absolute;
    left: 0;
    top: 4px;
    font-size: 24px;
    transition: left 0.05s linear;
}

.finish {
    position: absolute;
    right: 10px;
    top: 0;
    bottom: 0;
    width: 4px;
    background: gold;
}

.rank {
    background: rgba(0,0,0,0.3);
    margin: 20px auto;
    padding: 15px;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
}
</style>
</head>

<body>

<h1>ğŸ é©¬å¹´èµ›é©¬ Â· æ‘‡æ‰‹æœºï¼</h1>

<div>
    <input id="nameInput" placeholder="è¾“å…¥ä½ çš„åå­—">
    <button onclick="startRace()">å¼€å§‹æ¯”èµ›</button>
</div>

<div class="track" id="track">
    <div class="horse" id="horse">ğŸ</div>
    <div class="finish"></div>
</div>

<button id="shakeBtn">ğŸ“± æ‘‡æ‰‹æœºåŠ é€Ÿ</button>

<div class="rank">
    <h2>ğŸ† æ’åï¼ˆæŒ‰ç»ˆç‚¹æ—¶é—´ï¼‰</h2>
    <ol id="rankList"></ol>
</div>

<script>
/** ====== åŸºæœ¬å‚æ•° ====== **/
const TOTAL_DISTANCE = 1000;   // å›ºå®šèµ›ç¨‹
const STEP = 25;               // æ¯æ¬¡æ‘‡å‰è¿›è·ç¦»
const SHAKE_THRESHOLD = 15;    // æ‘‡åŠ¨å¼ºåº¦é˜ˆå€¼
const SHAKE_INTERVAL = 120;    // æ‘‡åŠ¨æœ€å°é—´éš”(ms)

/** ====== æ¸¸æˆçŠ¶æ€ ====== **/
let distance = 0;
let startTime = 0;
let finished = false;
let lastShakeTime = 0;

/** ====== æˆç»©åˆ—è¡¨ï¼ˆå½“å‰é¡µé¢ï¼‰ ====== **/
const results = [];

/** ====== å¼€å§‹æ¯”èµ› ====== **/
function startRace() {
    const name = document.getElementById("nameInput").value.trim();
    if (!name) {
        alert("è¯·è¾“å…¥åå­—");
        return;
    }

    distance = 0;
    finished = false;
    startTime = Date.now();
    document.getElementById("horse").style.left = "0px";
}

/** ====== é©¬å‰è¿›é€»è¾‘ ====== **/
function run() {
    if (finished || !startTime) return;

    distance += STEP;

    const trackWidth = document.getElementById("track").clientWidth - 60;
    const percent = Math.min(distance / TOTAL_DISTANCE, 1);
    document.getElementById("horse").style.left = (trackWidth * percent) + "px";

    if (distance >= TOTAL_DISTANCE) {
        finished = true;
        const timeUsed = (Date.now() - startTime) / 1000;

        results.push({
            name: document.getElementById("nameInput").value,
            time: timeUsed
        });

        updateRank();
    }
}

/** ====== æ’åæ›´æ–° ====== **/
function updateRank() {
    results.sort((a, b) => a.time - b.time);

    const list = document.getElementById("rankList");
    list.innerHTML = "";

    results.forEach((r, i) => {
        const li = document.createElement("li");
        li.textContent = `${r.name} â€”â€” ${r.time.toFixed(2)} ç§’`;
        list.appendChild(li);
    });
}

/** ====== æ‘‡ä¸€æ‘‡é€»è¾‘ ====== **/
function handleShake(event) {
    if (finished || !startTime) return;

    const acc = event.accelerationIncludingGravity;
    if (!acc) return;

    const now = Date.now();
    if (now - lastShakeTime < SHAKE_INTERVAL) return;

    const speed = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);

    if (speed > SHAKE_THRESHOLD) {
        lastShakeTime = now;
        run();
    }
}

/** ====== ç»‘å®šæ‘‡åŠ¨ï¼ˆå« iOS æƒé™ï¼‰ ====== **/
document.getElementById("shakeBtn").addEventListener("click", async function () {
    if (typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function") {

        const permission = await DeviceMotionEvent.requestPermission();
        if (permission !== "granted") {
            alert("éœ€è¦å…è®¸è¿åŠ¨ä¼ æ„Ÿå™¨æƒé™");
            return;
        }
    }

    window.addEventListener("devicemotion", handleShake, false);
});
</script>

</body>
</html>
