<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ğŸ é©¬å¹´èµ›é©¬ Â· å¹´ä¼šç‰ˆ</title>

<meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               maximum-scale=1.0,
               user-scalable=no">

<style>
* {
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    font-family: "Microsoft YaHei", sans-serif;
    background: linear-gradient(#8b1e1e, #c94a4a);
    color: #fff;
    text-align: center;
}

input, button {
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    margin: 6px;
}

button {
    background: gold;
}

.track {
    width: 90%;
    max-width: 600px;
    height: 40px;
    background: #4a2a2a;
    margin: 20px auto;
    border-radius: 20px;
    position: relative;
}

.horse {
    position: absolute;
    left: 0;
    top: 4px;
    font-size: 24px;
}

.finish {
    position: absolute;
    right: 10px;
    top: 0;
    bottom: 0;
    width: 4px;
    background: gold;
}

.rank {
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    margin: auto;
}

#qrcode {
    margin-top: 15px;
}
</style>
</head>

<body>

<h1>ğŸ é©¬å¹´èµ›é©¬</h1>

<div id="player">
    <input id="nameInput" placeholder="è¾“å…¥ä½ çš„åå­—">
    <button onclick="startRace()">å¼€å§‹</button>

    <div class="track">
        <div class="horse" id="horse">ğŸ</div>
        <div class="finish"></div>
    </div>

    <button id="shakeBtn">ğŸ“± æ‘‡æ‰‹æœºåŠ é€Ÿ</button>

    <div id="qrcode"></div>
</div>

<div id="screen" style="display:none">
    <h2>ğŸ† æ’è¡Œæ¦œ</h2>
    <ol id="rankList"></ol>
</div>

<!-- çœŸäºŒç»´ç åº“ -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
const TOTAL = 800;      // æ›´å®¹æ˜“è·‘å®Œ
const STEP = 40;
const SHAKE_THRESHOLD = 14;

let distance = 0;
let startTime = 0;
let finished = false;
let lastShake = 0;

const params = new URLSearchParams(location.search);
const isScreen = params.get("screen") === "1";

if (isScreen) {
    player.style.display = "none";
    screen.style.display = "block";
    loadRank();
}

function startRace() {
    if (!nameInput.value) return alert("è¯·è¾“å…¥åå­—");
    distance = 0;
    finished = false;
    startTime = Date.now();
    horse.style.left = "0px";
    qrcode.innerHTML = "";
}

function run() {
    if (finished || !startTime) return;

    distance += STEP;
    const width = document.querySelector(".track").clientWidth - 60;
    horse.style.left = Math.min(distance / TOTAL, 1) * width + "px";

    if (distance >= TOTAL) finish();
}

function finish() {
    finished = true;
    const time = ((Date.now() - startTime) / 1000).toFixed(2);

    const submitUrl =
        location.origin + location.pathname +
        `?submit=1&name=${encodeURIComponent(nameInput.value)}&time=${time}`;

    qrcode.innerHTML = "<p>ğŸ“¸ æ‰«ç æäº¤æˆç»©</p>";
    new QRCode(qrcode, {
        text: submitUrl,
        width: 200,
        height: 200
    });
}

shakeBtn.onclick = async () => {
    if (typeof DeviceMotionEvent?.requestPermission === "function") {
        const p = await DeviceMotionEvent.requestPermission();
        if (p !== "granted") return;
    }

    window.addEventListener("devicemotion", e => {
        const a = e.accelerationIncludingGravity;
        if (!a) return;

        const now = Date.now();
        if (now - lastShake < 120) return;

        const speed = Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z);
        if (speed > SHAKE_THRESHOLD) {
            lastShake = now;
            run();
        }
    });
};

if (params.get("submit") === "1") {
    const list = JSON.parse(localStorage.getItem("rank") || "[]");
    list.push({
        name: params.get("name"),
        time: parseFloat(params.get("time"))
    });
    localStorage.setItem("rank", JSON.stringify(list));
    location.href = location.pathname + "?screen=1";
}

function loadRank() {
    const list = JSON.parse(localStorage.getItem("rank") || "[]");
    rankList.innerHTML = "";
    list.sort((a,b)=>a.time-b.time).forEach(r=>{
        const li = document.createElement("li");
        li.textContent = `${r.name} â€”â€” ${r.time}s`;
        rankList.appendChild(li);
    });
}
</script>

</body>
</html>
